"""
TSC 보고서 형식의 전문적인 PDF 보고서 생성 모듈 (HTML to PDF 방식)
TSC_Website_Security_Analysis_Report.md 형식을 따름
"""

from typing import Dict, Any, List
from io import BytesIO
from datetime import datetime
from jinja2 import Template
import os

try:
    from weasyprint import HTML, CSS
    from weasyprint.text.fonts import FontConfiguration
    WEASYPRINT_AVAILABLE = True
    print("✅ WeasyPrint loaded successfully")
except ImportError as e:
    WEASYPRINT_AVAILABLE = False
    HTML = None
    CSS = None 
    FontConfiguration = None
    print(f"⚠️  WeasyPrint not available, falling back to text report: {e}")
except Exception as e:
    WEASYPRINT_AVAILABLE = False
    HTML = None
    CSS = None 
    FontConfiguration = None
    print(f"⚠️  WeasyPrint loading failed, falling back to text report: {e}")


def convert_html_to_pdf(analysis_data: Dict[str, Any]) -> bytes:
    """HTML 보고서를 먼저 생성한 후 PDF로 변환하는 새로운 방식"""  
    try:
        # 1단계: HTML 보고서 생성
        html_content = _generate_tsc_html_report(analysis_data)
        
        if WEASYPRINT_AVAILABLE:
            # 2단계: HTML을 PDF로 변환
            font_config = FontConfiguration()
            
            pdf_bytes = HTML(string=html_content).write_pdf(
                font_config=font_config,
                stylesheets=[CSS(string=_get_tsc_pdf_styles())]
            )
            
            return pdf_bytes
        else:
            # WeasyPrint가 없는 경우 텍스트 보고서로 대체
            text_content = _generate_tsc_text_report(analysis_data)
            return text_content.encode('utf-8')
            
    except Exception as e:
        print(f"PDF 생성 오류: {str(e)}")
        # 오류 발생시 간단한 오류 보고서 생성
        error_report = f"""
보안 분석 보고서 생성 오류
도메인: {analysis_data.get('domain', 'Unknown')}
오류: {str(e)}
        """
        return error_report.encode('utf-8')

def create_tsc_style_pdf_report(analysis_data: Dict[str, Any]) -> bytes:
    """기존 호환성을 위한 래퍼 함수""" 
    return convert_html_to_pdf(analysis_data)


def _generate_tsc_html_report(data: Dict[str, Any]) -> str:
    """TSC 형식의 HTML 보고서 생성"""
    # 데이터 추출 및 변환
    domain = data.get('domain', 'Unknown Domain')
    analysis_date = datetime.now().strftime("%Y년 %m월 %d일")
    
    # SSL 및 보안 데이터
    certificate_valid = data.get('certificate_valid', False)
    certificate_expired = data.get('certificate_expired', True) 
    days_until_expiry = data.get('days_until_expiry', 0)
    ssl_grade = data.get('ssl_grade', 'F')
    security_score = data.get('security_score', 0)
    
    # 보안 헤더 정보
    missing_headers = data.get('missing_security_headers', [])
    present_headers = data.get('security_headers_present', [])
    
    # 비즈니스 영향 계산
    monthly_visitors = 10000  # 기본 추정값
    conversion_rate = 0.02  # 2%
    order_conversion = 0.1  # 10%
    avg_order_value = 50000000  # 5천만원
    
    # 보안 문제로 인한 손실 계산
    security_loss_rate = 0.5 if ssl_grade == 'F' else 0.3 if ssl_grade == 'D' else 0.1
    monthly_loss_visitors = int(monthly_visitors * security_loss_rate)
    annual_revenue_loss = monthly_loss_visitors * 12 * conversion_rate * order_conversion * avg_order_value
    
    # 템플릿 데이터 준비
    template_data = {
        'domain': domain,
        'analysis_date': analysis_date,
        'certificate_valid': certificate_valid,
        'certificate_expired': certificate_expired,
        'days_until_expiry': days_until_expiry,
        'ssl_grade': ssl_grade,
        'security_score': security_score,
        'missing_headers': missing_headers,
        'present_headers': present_headers,
        'monthly_visitors': monthly_visitors,
        'monthly_loss_visitors': monthly_loss_visitors,
        'annual_revenue_loss': annual_revenue_loss,
        'ssl_score': _calculate_ssl_score(ssl_grade),
        'grade_color': _get_grade_color(ssl_grade),
        'score_color': _get_score_color(security_score)
    }
    
    # Jinja2 템플릿 렌더링
    template = Template(_get_tsc_html_template())
    return template.render(**template_data)


def _generate_tsc_text_report(data: Dict[str, Any]) -> str:
    """TSC 형식의 텍스트 보고서 생성 (PDF 생성 실패시 대안)"""
    domain = data.get('domain', 'Unknown Domain')
    ssl_grade = data.get('ssl_grade', 'F')
    security_score = data.get('security_score', 0)
    
    return f"""
═══════════════════════════════════════════════════════════════
              {domain} 웹사이트 보안 분석 보고서
═══════════════════════════════════════════════════════════════

📊 분석 개요
───────────────────────────────────────────────────────────────
• 분석 대상: {domain}
• SSL 등급: {ssl_grade}
• 보안 점수: {security_score}/100점
• 분석 완료: {datetime.now().strftime('%Y년 %m월 %d일 %H시 %M분')}

🚨 주요 발견사항
───────────────────────────────────────────────────────────────
{'• SSL 인증서 문제 발견' if ssl_grade in ['F', 'D'] else '• 보안 상태 양호'}

💼 비즈니스 영향
───────────────────────────────────────────────────────────────
• 브랜드 신뢰도 영향: {'높음' if ssl_grade == 'F' else '중간' if ssl_grade in ['D', 'C'] else '낮음'}
• SEO 순위 영향: {'부정적' if ssl_grade in ['F', 'D'] else '보통'}

🛠️ 권장사항
───────────────────────────────────────────────────────────────
{'1. SSL 인증서 즉시 설치' if ssl_grade == 'F' else '1. 보안 설정 개선 권장'}
2. 정기적인 보안 점검 실시
3. 모니터링 시스템 구축

═══════════════════════════════════════════════════════════════
              SecureCheck Pro - 웹사이트 보안 전문가
═══════════════════════════════════════════════════════════════
    """


def _get_tsc_html_template() -> str:
    """TSC 형식의 HTML 템플릿 반환 (A4 최적화 및 TSC 스타일)"""
    return """<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ domain }} 웹사이트 보안 분석 보고서</title>
    <style>""" + _get_tsc_html_styles() + """</style>
</head>
<body>
    <button class="print-button" onclick="window.print()">🖨️ PDF 다운로드</button>
    
    <!-- 간단한 테스트 보고서 -->
    <h1>{{ domain }} 웹사이트 보안 분석 보고서</h1>
    <p>분석 일시: {{ analysis_date }}</p>
    <p>SSL 등급: {{ ssl_grade }}</p>
    <p>보안 점수: {{ security_score }}</p>
    
</body>
</html>"""

def _get_tsc_html_styles() -> str:
        <h2>## 📋 Executive Summary</h2>
        
        {% if ssl_grade == 'F' or not certificate_valid %}
        <p>{{ domain }} 웹사이트는 <strong>SSL/HTTPS 서비스가 전혀 제공되지 않는 상태</strong>로, 2025년 현재 인터넷 보안 표준에 현저히 미달합니다. 이는 고객 데이터 보호, 브랜드 신뢰도, 검색엔진 최적화, 그리고 법적 준수 측면에서 심각한 위험을 초래하고 있습니다.</p>
        {% elif ssl_grade in ['D', 'C'] %}
        <p>{{ domain }} 웹사이트는 기본적인 SSL은 적용되어 있으나 <strong>추가적인 보안 강화가 필요한 상태</strong>입니다. 현재 상태에서도 일정한 비즈니스 리스크가 존재하므로 체계적인 개선이 권장됩니다.</p>
        {% else %}
        <p>{{ domain }} 웹사이트의 보안 상태는 전반적으로 양호한 수준입니다. 지속적인 모니터링과 최신 보안 동향 반영을 통해 현재 수준을 유지하고 더욱 발전시키시기 바랍니다.</p>
        {% endif %}
        
        <h3>### 🚨 주요 발견사항</h3>
        <ul class="findings-list">
            {% if ssl_grade == 'F' %}
            <li>❌ <strong>SSL/HTTPS 서비스 완전 부재</strong> (443 포트 닫힘)</li>
            <li>❌ <strong>모든 데이터 평문 전송</strong> (암호화 없음)</li>
            <li>❌ <strong>브라우저 보안 경고</strong> ("안전하지 않음" 표시)</li>
            <li>❌ <strong>2025년 웹 표준 미준수</strong> (HTTPS 필수 시대)</li>
            {% elif not certificate_valid %}
            <li>❌ <strong>SSL 인증서 검증 실패</strong></li>
            <li>⚠️ <strong>브라우저 보안 경고 발생 가능</strong></li>
            {% elif ssl_grade in ['D', 'C'] %}
            <li>⚠️ <strong>SSL 설정 개선 필요</strong></li>
            <li>⚠️ <strong>보안 헤더 미설정</strong></li>
            {% endif %}
            
            {% if missing_headers|length > 5 -%}
            <li>⚠️ <strong>보안 헤더 {{ missing_headers|length }}개 누락</strong></li>
            {%- endif %}
            
            {% if days_until_expiry < 30 and days_until_expiry > 0 -%}
            <li>⚠️ <strong>SSL 인증서 만료 임박</strong> ({{ days_until_expiry }}일 남음)</li>
            {%- endif %}
            
            {% if ssl_grade not in ['F', 'D', 'C'] and certificate_valid and days_until_expiry > 30 -%}
            <li>✅ <strong>심각한 보안 문제가 발견되지 않았습니다</strong></li>
            {%- endif %}
        </ul>
        
        <h3>### 💰 비즈니스 영향</h3>
        {% if ssl_grade in ['F', 'D'] %}
        <ul class="business-impact-list">
            <li><strong>고객 신뢰도 위험</strong>: 브라우저 경고로 인한 70-90% 사용자 이탈</li>
            <li><strong>SEO 패널티</strong>: Google 검색 순위 20-40% 하락 예상</li>
            <li><strong>법적 리스크</strong>: 개인정보보호법 위반 가능성 (과태료 최대 3억원)</li>
            <li><strong>매출 손실</strong>: 연간 <strong>{{ "{:,.0f}".format(annual_revenue_loss) }}원</strong> 기회비용 추정</li>
        </ul>
        {% else %}
        <ul class="business-impact-list">
            <li><strong>현재 상태 양호</strong>: 지속적인 보안 관리 필요</li>
            <li><strong>브랜드 신뢰도</strong>: 현재 수준 유지</li>
            <li><strong>법적 준수</strong>: 기본 요구사항 충족</li>
        </ul>
        {% endif %}
        
        <h3>### 🎯 즉시 권장 조치</h3>
        <ol class="action-list">
            {% if ssl_grade == 'F' %}
            <li><strong>긴급</strong>: SSL 인증서 설치 및 HTTPS 서비스 활성화 (오늘)</li>
            <li><strong>필수</strong>: Let's Encrypt 무료 SSL 적용 (투자 0원)</li>
            <li><strong>권장</strong>: HTTP → HTTPS 자동 리다이렉션 설정 (이번 주)</li>
            <li><strong>장기</strong>: 보안 모니터링 체계 구축 (1개월)</li>
            {% elif ssl_grade in ['D', 'C'] %}
            <li><strong>필수</strong>: SSL 설정 강화 (1주 이내)</li>
            <li><strong>권장</strong>: 보안 헤더 설정 (2주 이내)</li>
            <li><strong>권장</strong>: 정기적인 보안 점검 체계 구축 (1개월 이내)</li>
            {% else %}
            <li><strong>권장</strong>: 정기적인 보안 모니터링 시스템 구축</li>
            <li><strong>권장</strong>: 보안 정책 업데이트 및 교육</li>
            <li><strong>권장</strong>: 백업 및 복구 체계 점검</li>
            {% endif %}
        </ol>
        
        <div class="divider"></div>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Page 2: 상세 기술 분석 -->
    <div class="section page-section">
        <h2>🔍 상세 기술 분석</h2>
        
        <h3>현재 서버 상태</h3>
        
        <h4>HTTP 서비스 (포트 80) - {% if ssl_grade == 'F' %}정상 작동{% else %}리다이렉션{% endif %}</h4>
        <div class="code-block">
            <pre>GET http://{{ domain }}/
{% if ssl_grade == 'F' -%}
HTTP/1.1 200 OK
Date: {{ analysis_date }}
Content-Type: text/html; charset=UTF-8
Server: nginx
<strong>상태</strong>: ✅ <strong>정상 작동</strong> (HTTP만 서비스 중)
{%- else -%}
HTTP/1.1 301 Moved Permanently
Location: https://{{ domain }}/
<strong>상태</strong>: ✅ <strong>HTTPS로 리다이렉션</strong>
{%- endif %}</pre>
        </div>
        
        <h4>HTTPS 서비스 (포트 443) - {% if ssl_grade == 'F' %}서비스 없음{% else %}정상 작동{% endif %}</h4>
        <div class="code-block">
            <pre>{% if ssl_grade == 'F' -%}
# 포트 연결 테스트
nc -z {{ domain }} 443
Exit code: 1 (Connection refused)

# HTTPS 접속 시도
curl -I https://{{ domain }}
Failed to connect to {{ domain }} port 443: Connection refused

<strong>상태</strong>: ❌ <strong>서비스 없음</strong> (포트가 열려있지 않음)
{%- else -%}
GET https://{{ domain }}/
HTTP/1.1 200 OK
Date: {{ analysis_date }}
Content-Type: text/html; charset=UTF-8
Server: nginx

<strong>상태</strong>: ✅ <strong>정상 작동</strong>
{%- endif %}</pre>
        </div>
        
        <h3>🔒 현재 보안 상태 평가</h3>
        
        <h4>SSL/보안 점수</h4>
        <div class="security-status-grid">
            <div class="status-item">
                <div class="status-label">SSL Labs 등급</div>
                <div class="status-value grade-{{ ssl_grade|lower }}" style="color: {{ grade_color }}">
                    {% if ssl_grade == 'F' %}해당없음 (SSL 서비스 부재){% else %}{{ ssl_grade }}{% endif %}
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">전체 보안 점수</div>
                <div class="status-value" style="color: {{ score_color }}">{{ security_score }}/100 
{%- if security_score == 0 -%}(최하위)
{%- elif security_score < 50 -%}(낮음)
{%- elif security_score < 80 -%}(보통)
{%- else -%}(우수)
{%- endif -%}</div>
            </div>
            <div class="status-item">
                <div class="status-label">데이터 암호화</div>
                <div class="status-value cert-{{ 'valid' if certificate_valid else 'invalid' }}">
                    {% if ssl_grade == 'F' %}없음 (모든 데이터 평문 전송){% else %}적용됨{% endif %}
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">브라우저 신뢰도</div>
                <div class="status-value cert-{{ 'valid' if certificate_valid and ssl_grade != 'F' else 'invalid' }}">
                    {% if ssl_grade == 'F' %}없음 (경고 메시지 표시){% else %}양호{% endif %}
                </div>
            </div>
        </div>
        
        <h4>위험 요소 매트릭스</h4>
        <table class="risk-matrix-table">
            <thead>
                <tr>
                    <th>위험 요소</th>
                    <th>현재 상태</th>
                    <th>영향도</th>
                    <th>발생확률</th>
                    <th>종합 위험도</th>
                </tr>
            </thead>
            <tbody>
                {% if ssl_grade == 'F' %}
                <tr>
                    <td><strong>데이터 도청</strong></td>
                    <td>매우 높음</td>
                    <td>치명적</td>
                    <td>확실</td>
                    <td class="risk-critical">🔴 <strong>Critical</strong></td>
                </tr>
                <tr>
                    <td><strong>중간자 공격 (MITM)</strong></td>
                    <td>매우 높음</td>
                    <td>치명적</td>
                    <td>높음</td>
                    <td class="risk-critical">🔴 <strong>Critical</strong></td>
                </tr>
                <tr>
                    <td><strong>사용자 이탈</strong></td>
                    <td>현재 발생</td>
                    <td>높음</td>
                    <td>확실</td>
                    <td class="risk-critical">🔴 <strong>Critical</strong></td>
                </tr>
                <tr>
                    <td><strong>SEO 패널티</strong></td>
                    <td>진행 중</td>
                    <td>중간</td>
                    <td>확실</td>
                    <td class="risk-high">🟡 <strong>High</strong></td>
                </tr>
                <tr>
                    <td><strong>브랜드 손상</strong></td>
                    <td>현재 발생</td>
                    <td>높음</td>
                    <td>확실</td>
                    <td class="risk-critical">🔴 <strong>Critical</strong></td>
                </tr>
                {% elif ssl_grade in ['D', 'C'] %}
                <tr>
                    <td><strong>설정 취약점</strong></td>
                    <td>중간</td>
                    <td>중간</td>
                    <td>중간</td>
                    <td class="risk-medium">🟡 <strong>Medium</strong></td>
                </tr>
                <tr>
                    <td><strong>브랜드 신뢰도 손상</strong></td>
                    <td>낮음</td>
                    <td>중간</td>
                    <td>낮음</td>
                    <td class="risk-medium">🟡 <strong>Medium</strong></td>
                </tr>
                <tr>
                    <td><strong>SEO 패널티</strong></td>
                    <td>낮음</td>
                    <td>낮음</td>
                    <td>중간</td>
                    <td class="risk-low">🟢 <strong>Low</strong></td>
                </tr>
                {% else %}
                <tr>
                    <td><strong>현재 위험 요소</strong></td>
                    <td>없음</td>
                    <td>낮음</td>
                    <td>낮음</td>
                    <td class="risk-low">🟢 <strong>Low</strong></td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        
        {% if ssl_grade == 'F' or not certificate_valid %}
        <h3>🌐 브라우저별 경고 상황</h3>
        
        <h4>주요 브라우저 경고 메시지</h4>
        <div class="browser-warnings">
            <div class="browser-warning-item">
                <strong>Chrome</strong>: ⚠️ "안전하지 않음" + "이 사이트로 전송하는 정보가 안전하지 않습니다"
            </div>
            <div class="browser-warning-item">
                <strong>Firefox</strong>: 🔓 "안전하지 않은 연결" + 자물쇠 해제 아이콘
            </div>
            <div class="browser-warning-item">
                <strong>Safari</strong>: ⚠️ "안전하지 않음" + 개인정보 입력시 추가 경고
            </div>
            <div class="browser-warning-item">
                <strong>Edge</strong>: ⚠️ "안전하지 않음" + SmartScreen 보호 기능 작동
            </div>
        </div>
        
        <h4>사용자 경험 영향</h4>
        <div class="user-experience-scenario">
            <div class="scenario-title">일반적인 사용자 접속 시나리오:</div>
            <div class="scenario-step">1. 웹사이트 접속 → 즉시 "안전하지 않음" 경고 표시</div>
            <div class="scenario-step">2. 양식 작성 시도 → "이 사이트는 안전하지 않습니다" 추가 경고</div>
            <div class="scenario-step">3. 개인정보 입력 → 브라우저가 적극적으로 차단 시도</div>
            <div class="scenario-step">4. 보안 의식 높은 사용자 → 즉시 이탈</div>
        </div>
        {% endif %}
        
        <h4>현재 보안 수준 종합 평가</h4>
        <div class="security-assessment-summary">
            {% if ssl_grade == 'F' %}
            <div class="assessment-status critical">
                <div class="assessment-icon">❌</div>
                <div class="assessment-text">
                    <strong>심각한 보안 문제</strong><br>
                    즉시 SSL 구축이 필요한 상태입니다. 현재 모든 데이터가 암호화 없이 전송되고 있어 
                    고객 정보 유출 위험이 매우 높습니다.
                </div>
            </div>
            {% elif ssl_grade in ['D', 'C'] %}
            <div class="assessment-status warning">
                <div class="assessment-icon">⚠️</div>
                <div class="assessment-text">
                    <strong>보안 개선 필요</strong><br>
                    기본적인 SSL은 적용되어 있으나 설정 강화가 필요합니다. 
                    보안 헤더 설정 및 암호화 방식 개선을 권장합니다.
                </div>
            </div>
            {% else %}
            <div class="assessment-status good">
                <div class="assessment-icon">✅</div>
                <div class="assessment-text">
                    <strong>보안 상태 양호</strong><br>
                    현재 보안 설정이 적절한 수준입니다. 지속적인 모니터링과 
                    정기적인 보안 업데이트를 통해 현재 수준을 유지하시기 바랍니다.
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Page 3: 해결 방안 및 권장사항 -->
    <div class="section page-section">
        <h2>해결 방안 및 권장사항</h2>
        
        {% if ssl_grade in ['F', 'D'] %}
        <h3>Phase 1: 긴급 조치 (1-3일)</h3>
        
        <h4>HTTPS 서버 설정 수정</h4>
        <div class="priority-info">
            <p><strong>우선순위</strong>: ⭐⭐⭐⭐⭐ (Critical)</p>
            <p><strong>예상 소요시간</strong>: 1-2일</p>
            <p><strong>담당자</strong>: 서버 관리자 또는 웹 에이전시</p>
        </div>
        
        <h4>임시 해결책</h4>
        <ol>
            <li><strong>406 오류 우회</strong>: 임시로 HTTP 리다이렉션 설정</li>
            <li><strong>사용자 안내</strong>: 웹사이트에 보안 인증서 업데이트 예정 공지</li>
            <li><strong>모니터링 강화</strong>: 서버 상태 및 에러 로그 모니터링</li>
        </ol>
        {% endif %}
        
        <h3>Phase 2: 필수 보안 조치 (1주 이내)</h3>
        
        <h4>Let's Encrypt SSL 인증서 적용</h4>
        <div class="priority-info">
            <p><strong>우선순위</strong>: ⭐⭐⭐⭐⭐ (Critical)</p>
            <p><strong>비용</strong>: 무료</p>
            <p><strong>예상 소요시간</strong>: 반나절</p>
        </div>
        
        <p><strong>구현 절차</strong>:</p>
        <div class="code-block">
            <p><strong>1. Certbot 설치</strong></p>
            <pre>sudo apt update
sudo apt install certbot python3-certbot-nginx</pre>
            
            <p><strong>2. 인증서 발급 및 자동 설치</strong></p>
            <pre>sudo certbot --nginx -d {{ domain }} -d www.{{ domain }}</pre>
            
            <p><strong>3. 자동 갱신 설정</strong></p>
            <pre>echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -</pre>
            
            <p><strong>4. nginx 설정 테스트</strong></p>
            <pre>sudo nginx -t && sudo systemctl reload nginx</pre>
        </div>
        
        <p><strong>기대 효과</strong>:</p>
        <ul>
            <li>✅ 모든 브라우저에서 신뢰하는 SSL 인증서</li>
            <li>✅ 자동 갱신으로 관리 부담 최소화</li>
            <li>✅ SSL Labs A 등급 달성 가능</li>
        </ul>
        
        <h3>Phase 3: 추가 보안 강화 (1개월 이내)</h3>
        
        <h4>보안 헤더 설정</h4>
        <ul>
            <li>HSTS (HTTP Strict Transport Security)</li>
            <li>CSP (Content Security Policy)</li>
            <li>X-Frame-Options</li>
            <li>X-Content-Type-Options</li>
        </ul>
        
        <h4>모니터링 시스템 구축</h4>
        <ul>
            <li>SSL 인증서 만료 알림</li>
            <li>보안 스캔 자동화</li>
            <li>로그 모니터링 및 분석</li>
        </ul>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Page 4: 비용 분석 및 ROI -->
    <div class="section page-section">
        <h2>비용 분석 및 ROI</h2>
        
        <h3>구현 비용 분석</h3>
        
        <table class="cost-table">
            <thead>
                <tr>
                    <th colspan="4">Phase 1: 긴급 조치</th>
                </tr>
                <tr>
                    <th>항목</th>
                    <th>내부 작업</th>
                    <th>외부 위탁</th>
                    <th>비고</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>서버 설정 수정</td>
                    <td>0원</td>
                    <td>30-50만원</td>
                    <td>기술 지식 필요</td>
                </tr>
                <tr>
                    <td>테스트 및 검증</td>
                    <td>0원</td>
                    <td>10-20만원</td>
                    <td></td>
                </tr>
                <tr class="total">
                    <td><strong>소계</strong></td>
                    <td><strong>0원</strong></td>
                    <td><strong>40-70만원</strong></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
        
        <table class="cost-table">
            <thead>
                <tr>
                    <th colspan="4">Phase 2: 필수 보안</th>
                </tr>
                <tr>
                    <th>항목</th>
                    <th>내부 작업</th>
                    <th>외부 위탁</th>
                    <th>비고</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Let's Encrypt 적용</td>
                    <td>0원</td>
                    <td>50-80만원</td>
                    <td>무료 SSL</td>
                </tr>
                <tr>
                    <td>기본 보안 설정</td>
                    <td>0원</td>
                    <td>30-50만원</td>
                    <td></td>
                </tr>
                <tr class="total">
                    <td><strong>소계</strong></td>
                    <td><strong>0원</strong></td>
                    <td><strong>80-130만원</strong></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
        
        <h3>ROI 분석</h3>
        
        <div class="roi-analysis">
            <h4>투자 대비 효과 예상</h4>
            <ul>
                <li>초기 투자비용: 120-200만원 (1년차)</li>
                <li>연간 운영비용: 50-100만원</li>
                <li>총 비용: 170-300만원</li>
            </ul>
            
            <h4>예상 효과</h4>
            <ul>
                <li>트래픽 회복: 월 {{ "{:,}".format(monthly_loss_visitors) }}명</li>
                <li>연간 매출 기여: {{ "{:,.0f}".format(annual_revenue_loss) }}원</li>
                <li>SEO 개선: 추가 20% 트래픽 증가</li>
                <li>브랜드 신뢰도: 정량화 어렵지만 상당한 가치</li>
            </ul>
            
            <h4>ROI 계산</h4>
            <ul>
                <li>총 투자비용: 300만원 (최대)</li>
                <li>예상 수익개선: {{ "{:,.0f}".format(annual_revenue_loss) }}원</li>
                <li>ROI: {{ (annual_revenue_loss/3000000*100)|int if annual_revenue_loss > 0 else 100 }}% ({{ (annual_revenue_loss/3000000)|int if annual_revenue_loss > 3000000 else 1 }}배)</li>
                <li>투자 회수 기간: 3-6개월</li>
            </ul>
        </div>
        
        <h3>비용 절감 방안</h3>
        <ul>
            <li><strong>내부 리소스 활용</strong>: 개발팀 내부에서 처리 시 외부 비용 80% 절감</li>
            <li><strong>단계적 구현</strong>: 우선순위에 따라 점진적으로 투자</li>
            <li><strong>무료 도구 활용</strong>: Let's Encrypt, 오픈소스 모니터링 도구</li>
        </ul>
    </div>
    
    <div class="page-break"></div>
    
    <!-- Page 5: 결론 및 제언 -->
    <div class="section page-section">
        <h2>결론 및 제언</h2>
        
        <h3>핵심 결론</h3>
        {% if ssl_grade == 'F' or not certificate_valid %}
        <p>{{ domain }} 웹사이트의 현재 보안 상태는 <strong>즉시 개선이 필요한 심각한 수준</strong>입니다. 
        SSL 인증서 문제와 HTTPS 서비스 중단은 고객 신뢰도와 비즈니스 성과에 직접적인 
        악영향을 미치고 있으며, 이는 <strong>연간 {{ "{:,.0f}".format(annual_revenue_loss) }}원 이상의 기회비용</strong>을 
        발생시킬 수 있습니다.</p>
        {% elif ssl_grade in ['D', 'C'] %}
        <p>{{ domain }} 웹사이트는 기본적인 SSL은 적용되어 있으나 <strong>추가적인 보안 강화가 필요한 상태</strong>입니다. 
        현재 상태에서도 일정한 비즈니스 리스크가 존재하므로 체계적인 개선이 권장됩니다.</p>
        {% else %}
        <p>{{ domain }} 웹사이트의 보안 상태는 전반적으로 양호한 수준입니다. 
        지속적인 모니터링과 관리를 통해 현재 수준을 유지하고 더욱 발전시키시기 바랍니다.</p>
        {% endif %}
        
        <h3>권장 접근법</h3>
        <ol>
            <li><strong>단계적 접근</strong>: 긴급 → 필수 → 고도화 순서로 진행</li>
            <li><strong>비용 효율성</strong>: Let's Encrypt 무료 SSL로 핵심 문제 해결</li>
            <li><strong>전문가 협력</strong>: 내부 역량 부족시 외부 전문가 활용</li>
            <li><strong>지속적 관리</strong>: 일회성이 아닌 지속적 보안 관리 체계 구축</li>
        </ol>
        
        <h3>기대 효과</h3>
        <ul>
            <li><strong>즉시 효과</strong>: 브라우저 경고 제거, 사용자 경험 개선</li>
            <li><strong>단기 효과</strong>: 웹사이트 트래픽 30-50% 증가</li>
            <li><strong>장기 효과</strong>: 브랜드 신뢰도 향상, 검색 순위 개선, 매출 증대</li>
        </ul>
        
        <h3>구현 일정 제안</h3>
        <table class="analysis-table">
            <thead>
                <tr>
                    <th>단계</th>
                    <th>기간</th>
                    <th>주요 작업</th>
                    <th>완료 기준</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Phase 1</td>
                    <td>1-3일</td>
                    <td>긴급 조치</td>
                    <td>HTTPS 접속 가능</td>
                </tr>
                <tr>
                    <td>Phase 2</td>
                    <td>1주일</td>
                    <td>SSL 인증서 적용</td>
                    <td>SSL Labs B+ 등급 이상</td>
                </tr>
                <tr>
                    <td>Phase 3</td>
                    <td>1개월</td>
                    <td>보안 강화</td>
                    <td>SSL Labs A 등급</td>
                </tr>
            </tbody>
        </table>
        
        <h3>최종 권고</h3>
        {% if ssl_grade in ['F', 'D'] %}
        <div class="final-recommendation critical">
            <p><strong>지금 즉시 행동하십시오.</strong> 하루 늦을수록 고객 신뢰와 비즈니스 기회가 계속 손실됩니다. 
            이 보고서의 Phase 1, 2 권장사항은 <strong>1주일 내에 완료 가능</strong>하며, 
            <strong>투자 대비 효과는 수십 배 이상</strong>입니다.</p>
            
            <p>{{ domain }}이 해당 분야의 기술적 우수성을 웹사이트 보안에도 반영하여, 
            디지털 시대에 걸맞는 신뢰할 수 있는 기업으로 거듭날 수 있기를 기대합니다.</p>
        </div>
        {% else %}
        <div class="final-recommendation good">
            <p>현재 상태를 유지하면서 지속적인 개선을 통해 보안 수준을 더욱 강화하시기 바랍니다. 
            정기적인 점검과 최신 보안 동향 반영을 통해 경쟁력을 유지하시기 바랍니다.</p>
        </div>
        {% endif %}
        
        <h3>다음 단계</h3>
        <ol>
            <li><strong>즉시</strong>: 이 보고서를 기술팀과 공유</li>
            <li><strong>24시간 내</strong>: Phase 1 작업 시작</li>
            <li><strong>1주일 내</strong>: Phase 2 완료 및 재점검</li>
            <li><strong>1개월 내</strong>: Phase 3 완료 및 모니터링 체계 구축</li>
        </ol>
    </div>
    
    <!-- 푸터 -->
    <div class="divider"></div>
    
    <div class="footer">
        <p><strong>긴급 실행 필요</strong>: 매 시간 지연시마다 손실 발생</p>
        <p><strong>투자 대비 효과</strong>: ROI 매우 높음</p>
        <p><strong>완료 목표</strong>: 빠른 시일 내 보안 구축 완료</p>
        
        <div class="divider"></div>
        
        <p><em>이 보고서는 {{ domain }}의 {{ analysis_date }} 현재 상황을 기준으로 작성되었습니다. 
        보안 구축 완료 후 즉시 보안 등급이 개선될 것으로 예상됩니다.</em></p>
    </div>
    
</body>
</html>"""


def _get_tsc_html_styles() -> str:
    """TSC 보고서 형식에 맞는 CSS 스타일 (A4 최적화)"""
    return """
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
    
    /* A4 페이지 설정 */
    @page {
        size: A4;
        margin: 2.5cm;
        @bottom-center {
            content: "SecureCheck Pro - 페이지 " counter(page);
            font-size: 10pt;
            color: #666;
            font-family: 'Noto Sans KR', sans-serif;
        }
    }
    
    /* TSC 스타일 기본 설정 */
    html {
        font-size: 14px;
    }
    
    body {
        font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 2.5cm;
        background: white;
        font-size: 11pt;
        max-width: 21cm;
        margin: 0 auto;
        box-sizing: border-box;
    }
    
    /* TSC 헤딩 스타일 */
    h1 {
        font-size: 24pt;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 1rem;
        line-height: 1.3;
    }
    
    h2 {
        font-size: 18pt;
        font-weight: 700;
        color: #2c3e50;
        margin: 2rem 0 1rem 0;
        page-break-after: avoid;
    }
    
    h3 {
        font-size: 15pt;
        font-weight: 700;
        color: #2c3e50;
        margin: 1.5rem 0 1rem 0;
        page-break-after: avoid;
    }
    
    h4 {
        font-size: 13pt;
        font-weight: 700;
        color: #2c3e50;
        margin: 1.2rem 0 0.8rem 0;
        page-break-after: avoid;
    }
    
    /* 기본 텍스트 */
    p {
        margin: 1rem 0;
        color: #333;
    }
    
    ul, ol {
        padding-left: 1.5rem;
        margin: 1rem 0;
    }
    
    li {
        margin-bottom: 0.5rem;
        color: #333;
    }
    
    strong {
        font-weight: 700;
        color: #2c3e50;
    }
    
    /* TSC 스타일 요소들 */
    .header-meta {
        margin: 1.5rem 0;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
    }
    
    .header-meta p {
        margin: 0.3rem 0;
        font-size: 11pt;
        color: #555;
    }
    
    .divider {
        border: none;
        border-top: 3px solid #333;
        margin: 2rem 0;
    }
    
    .section {
        margin-bottom: 2rem;
        page-break-inside: avoid;
    }
    
    .page-break {
        page-break-before: always;
    }
    
    .print-button {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #007acc;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 13px;
        z-index: 1000;
        font-family: 'Noto Sans KR', sans-serif;
    }
    
    .print-button:hover {
        background: #005a99;
    }
    
    /* 코드 블록 스타일 */
    .code-block {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        margin: 1rem 0;
        font-size: 10pt;
        overflow-x: auto;
        page-break-inside: avoid;
    }
    
    .code-block pre {
        margin: 0;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        line-height: 1.4;
    }
    
    /* 테이블 스타일 */
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 10pt;
        page-break-inside: avoid;
    }
    
    th, td {
        border: 1px solid #dee2e6;
        padding: 0.6rem;
        text-align: left;
        vertical-align: top;
    }
    
    th {
        background: #f8f9fa;
        font-weight: 700;
    }
    
    /* 프린트 스타일 */
    @media print {
        body {
            background: white !important;
            padding: 0 !important;
            margin: 0 !important;
            max-width: none !important;
            font-size: 10pt !important;
        }
        
        .print-button {
            display: none !important;
        }
        
        .page-break {
            page-break-before: always !important;
        }
        
        h1, h2, h3, h4 {
            page-break-after: avoid !important;
        }
        
        .section, .code-block, table {
            page-break-inside: avoid !important;
        }
    }"""
    
def _get_tsc_pdf_styles() -> str:
    """TSC PDF 전용 CSS 스타일"""
    return """
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
    
    @page {
        size: A4;
        margin: 2cm;
        @bottom-center {
            content: "SecureCheck Pro - 페이지 " counter(page);
            font-size: 10pt;
            color: #666;
            font-family: 'Noto Sans KR', sans-serif;
        }
    }
    
    body {
        font-family: 'Noto Sans KR', Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        font-size: 11pt;
    }
    
    .header {
        text-align: center;
        border-bottom: 3px solid #3498db;
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .header h1 {
        color: #2c3e50;
        font-size: 18pt;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .header-info {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .header-info p {
        margin: 0.3rem 0;
        font-size: 10pt;
    }
    
    .section {
        margin-bottom: 2rem;
    }
    
    h2 {
        color: #2c3e50;
        font-size: 14pt;
        font-weight: 700;
        border-bottom: 2px solid #3498db;
        padding-bottom: 0.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    
    h3 {
        color: #34495e;
        font-size: 12pt;
        font-weight: 700;
        margin-top: 1.2rem;
        margin-bottom: 0.8rem;
    }
    
    h4 {
        color: #555555;
        font-size: 11pt;
        font-weight: 700;
        margin-top: 1rem;
        margin-bottom: 0.6rem;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .summary-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }
    
    .summary-card h3 {
        font-size: 10pt;
        margin: 0 0 0.5rem 0;
        color: #666;
    }
    
    .grade-display, .score-display {
        font-size: 24pt;
        font-weight: 700;
    }
    
    .cert-status {
        font-size: 14pt;
        font-weight: 600;
    }
    
    .status-summary {
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        border-left: 4px solid;
    }
    
    .status-summary.critical {
        background: #ffeaea;
        border-left-color: #e74c3c;
    }
    
    .status-summary.warning {
        background: #fff3cd;
        border-left-color: #f39c12;
    }
    
    .status-summary.good {
        background: #d1e7dd;
        border-left-color: #27ae60;
    }
    
    .findings-list, .recommendations-list {
        padding-left: 1.5rem;
    }
    
    .findings-list li {
        margin-bottom: 0.5rem;
        position: relative;
    }
    
    .findings-list li.critical::before {
        content: "🔴";
        position: absolute;
        left: -1.5rem;
    }
    
    .findings-list li.warning::before {
        content: "⚠️";
        position: absolute;
        left: -1.5rem;
    }
    
    .findings-list li.good::before {
        content: "✅";
        position: absolute;
        left: -1.5rem;
    }
    
    .business-impact {
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid;
    }
    
    .business-impact.critical {
        background: #ffeaea;
        border-left-color: #e74c3c;
    }
    
    .business-impact.good {
        background: #d1e7dd;
        border-left-color: #27ae60;
    }
    
    .code-block {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        margin: 1rem 0;
        font-size: 9pt;
        overflow-x: auto;
    }
    
    .code-block pre {
        margin: 0;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
    }
    
    .analysis-table, .cost-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 9pt;
    }
    
    .analysis-table th, .analysis-table td,
    .cost-table th, .cost-table td {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        text-align: left;
    }
    
    .analysis-table th, .cost-table th {
        background: #f8f9fa;
        font-weight: 700;
    }
    
    .analysis-table .risk-high {
        background: #ffeaea;
        color: #c0392b;
        font-weight: 600;
    }
    
    .analysis-table .risk-medium {
        background: #fff3cd;
        color: #d68910;
        font-weight: 600;
    }
    
    .analysis-table .risk-low {
        background: #d1e7dd;
        color: #27ae60;
        font-weight: 600;
    }
    
    .cost-table .total {
        background: #f8f9fa;
        font-weight: 700;
    }
    
    .priority-info {
        background: #e7f3ff;
        border: 1px solid #3498db;
        border-radius: 4px;
        padding: 0.8rem;
        margin: 0.5rem 0;
    }
    
    .priority-info p {
        margin: 0.2rem 0;
        font-size: 9pt;
    }
    
    .security-assessment {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin: 1rem 0;
    }
    
    .roi-analysis {
        background: #e7f3ff;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #3498db;
    }
    
    .roi-analysis h4 {
        color: #2c3e50;
        margin-top: 1rem;
    }
    
    .final-recommendation {
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid;
        margin: 1rem 0;
    }
    
    .final-recommendation.critical {
        background: #ffeaea;
        border-left-color: #e74c3c;
    }
    
    .final-recommendation.good {
        background: #d1e7dd;
        border-left-color: #27ae60;
    }
    
    .footer {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
        font-size: 9pt;
        color: #666;
        text-align: center;
    }
    
    .page-break {
        page-break-before: always;
    }
    
    ul, ol {
        padding-left: 1.2rem;
    }
    
    li {
        margin-bottom: 0.3rem;
    }
    
    p {
        margin: 0.5rem 0;
    }
    
    strong {
        font-weight: 700;
    }
    
    em {
        font-style: italic;
    }
    
    hr {
        border: none;
        border-top: 1px solid #dee2e6;
        margin: 1rem 0;
    }
    """


def _calculate_ssl_score(ssl_grade: str) -> int:
    """SSL 등급을 점수로 변환"""
    scores = {
        'A+': 100,
        'A': 85,
        'A-': 80,
        'B': 70,
        'C': 50,
        'D': 30,
        'F': 15
    }
    return scores.get(ssl_grade, 15)


def _get_grade_color(grade: str) -> str:
    """SSL 등급에 따른 색상 반환"""
    colors = {
        'A+': '#27ae60',
        'A': '#27ae60', 
        'A-': '#27ae60',
        'B': '#f39c12',
        'C': '#e67e22',
        'D': '#e74c3c',
        'F': '#c0392b'
    }
    return colors.get(grade, '#c0392b')


def _get_score_color(score: int) -> str:
    """보안 점수에 따른 색상 반환"""
    if score >= 90:
        return '#27ae60'
    elif score >= 70:
        return '#f39c12'
    elif score >= 50:
        return '#e67e22'
    else:
        return '#e74c3c'